%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  tutorial.tex
%
%  Introductory tutorial for new users of Ludwig. 
%
%  Edinburgh Soft Matter and Statistical Physics Group and
%  Edinburgh Parallel Computing Centre and
%  Department of Physics, University of Strathclyde
%
%  Contributing authors:
%  Oliver Henrich (oliver.henrich@strath.ac.uk)
%  Fraser Mackay (s1026487@sms.ed.ac.uk)
%
%  (c) 2008-2017 The University of Edinburgh
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[11pt,twoside,a4paper]{article}

\usepackage{amsmath}
\usepackage{moreverb}
\usepackage{lscape}
\usepackage{epic}
\usepackage[pdftex]{graphicx}
\usepackage{bm}
\usepackage{hyperref}
\usepackage{color}
\usepackage{listings}
\usepackage{mathtools}
\usepackage{enumerate}
\usepackage{float}
\graphicspath{{./tutorialFigs/}}

\usepackage{geometry}
 \geometry{
 a4paper,
 left=3.1cm,
 right=3.1cm,
 top=2.25cm,
 bottom=2.25cm 
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{\smallskipamount}

\newcommand{\inputkey}[1]{\framebox{\textbf{\texttt{#1}}}}
\newcommand{\e}[1]{\cdot10^{#1}}
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\beqa}{\begin{eqnarray}}
\newcommand{\eeqa}{\end{eqnarray}}
\newcommand{\com}[1]{\textcolor{red}{#1}}
\newcommand{\plag}[1]{\textcolor{green}{#1}}
\newcommand{\cur}[1]{{\textit{#1}}}

\definecolor{terminalcolour}{gray}{0.96}

\lstdefinestyle{terminalverbatim}{
  basicstyle=\small\ttfamily,
  columns=flexible,
  backgroundcolor=\color{terminalcolour},
  xleftmargin=0pt
}


\begin{document}


\setcounter{page}{1}

% We're not including the table of contents just at the moment
%\tableofcontents

\newpage
\lstset{style=terminalverbatim}

\setcounter{page}{1}

% These redefinitions are just compressing the spacing a little.

\makeatletter
\renewcommand*{\section}{%
\@startsection {section}{1}{\z@}%
  {-1.75ex \@plus -0.5ex \@minus -.1ex}%
  {1.15ex \@plus.1ex}%
  {\normalfont\Large\bfseries}%
}
\renewcommand*{\subsection}{%
\@startsection {subsection}{2}{\z@}%
  {-1.75ex \@plus -0.5ex \@minus -.1ex}%
  {1.15ex \@plus.1ex}%
  {\normalfont\large\bfseries}%
}
\renewcommand*{\subsubsection}{%
\@startsection {subsubsection}{1}{\z@}%
  {-1.75ex \@plus -0.5ex \@minus -.1ex}%
  {1.15ex \@plus.1ex}%
  {\normalfont\normalsize\bfseries}%
}

% Table of Contents
\pagenumbering{roman}
\title{Ludwig User Tutorial}
\author{Fraser Mackay and Oliver Henrich}
\maketitle 
\tableofcontents
\clearpage

% Sections
\pagenumbering{arabic}

\section{Introduction}

This tutorial document takes new users of the \texttt{Ludwig} code through the process of how to obtain 
and build the code before outlining some short tutorial exercises where simulations 
of simple example cases will be run and visualised.
It is assumed that the reader is familar with UNIX-based operationg systems and has 
a basic knowledge of hydrodynamics, complex fluids, and to some extent statistical physics. 
This knowledge will be required to make sense of the input and output involved in using the code. 

The system requirements are an up-to-date version of a C compiler as well as working installations 
of Apache's Subversion (SVN) version control system, the visualisation tool
ParaView (\hyperref[ParaView]{https://www.paraview.org}), the MPI-library 
for compiling the parallel version of the code and \texttt{gnuplot} for simple visualisations.

\section{Access and Compilation}

\subsection{Obtaining the Code}
\label{sec:getCode}

The \texttt{Ludwig} project is currently hosted at our central repository 
at CCPForge:\\
(\hyperref[CCPForge]{https://ccpforge.cse.rl.ac.uk}).\\
For full access to the repository please open a CCPForge account and request
to join the project \texttt{Ludwig}. The following command grants anonymous access:

\begin{lstlisting}[style=terminalverbatim]
$ svn checkout https://ccpforge.cse.rl.ac.uk/svn/ludwig
\end{lstlisting}

A copy of the \texttt{Ludwig} repository will now be available in your current directory. 
You should see:

\begin{lstlisting}
$ ls ludwig
branches  tags  trunk
\end{lstlisting}
which is the usual svn layout for trunk, branches and tagged versions.

A full documentation of \texttt{Ludwig} can be obtained by running 
the command \texttt{make pdf} twice in the \texttt{/trunk/docs} directory:

\begin{lstlisting}[style=terminalverbatim]
$ cd /ludwig/trunk/docs/
$ make pdf
\end{lstlisting}

\subsection{Configuration and Build}

The following section outlines the configuration and compilation 
procedure. The configuration step is based on the GNU Compiler Collection gcc.

\begin{enumerate}
\item Go to the directory \texttt{/ludwig/trunk/}: \\
\begin{lstlisting}
$ cd ludwig/trunk
\end{lstlisting}
\item Copy the configuration file \texttt{lunix-gcc-default.mk} to the \texttt{/trunk} directory 
and rename to \texttt{config.mk}: \\
\begin{lstlisting}
$ cp config/lunix-gcc-default.mk ./config.mk
\end{lstlisting}
\item Issue \texttt{make} in \texttt{/targetDP}: \\
\begin{lstlisting}
$ cd targetDP/
$ make 
\end{lstlisting}
This creates dummy functions for calls to the targetDP library.
\item Issue \texttt{make} in \texttt{/mpi\_s}: \\
\begin{lstlisting}
$ cd ../mpi_s/
$ make 
\end{lstlisting}
This creates dummy functions for calls to the MPI-library,
which is required for serial compilation.
\item Edit \texttt{Makefile} in \texttt{/src}. To switch off 
the assertions set \texttt{OPTS = -DNP\_D3Q6 -DNDEBUG}. This is
important for production runs (see also comment in \texttt{Makefile}): \\
\begin{lstlisting}
$ cd ../src/
$ vim Makefile
...

include ../Makefile.mk

MAIN = main
EXECUTABLE = Ludwig.exe
LIBRARY = libludwig.a

OPTS = -DNP_D3Q6 -DNDEBUG
LIBS = -L../targetDP -ltarget -lm
INC = -I. -I ../targetDP
...
\end{lstlisting}
\item To compile the code in serial issue: \\
\begin{lstlisting}
$ make serial
\end{lstlisting} 
To compile the parallel version of the code issue: \\
\begin{lstlisting}
$ make mpi
\end{lstlisting} 
This creates the executable file \texttt{Ludwig.exe} in \texttt{/src}.
\end{enumerate}

\section{Tutorial Test Exercises}

\subsection{Test 1: Poiseuille Flow of a Simple Fluid in a Cavity}

In this section the Poiseuille flow of a simple fluid in a cavity, is outlined. 
The example is a step-by-step guide for performing a short run ($10,000$ time-steps) 
with \texttt{Ludwig} code, followed by a short introduction to the post-processing 
and data analysis procedures. Before starting, the code should be compiled in 
parallel and the executable \texttt{Ludwig.exe} should be copied into your working directory.

\begin{enumerate}
\item Copy the input file \texttt{input} located in the directory \texttt{/trunk/docs/tutorial/test1} 
to your working directory. Note that this input file is a modified version of the 
reference input file \texttt{input.ref} located in \texttt{/trunk/src} with a limited set of parameters
for this run. 
\item Run the code in your working directory by issuing the command:
\begin{lstlisting}
$ mpirun -np 4 ./Ludwig.exe input
\end{lstlisting}
\item You should now see statistics being reported on your standard output and 
output files being created with names of the form \texttt{vel-XXXXXXXX.001-001}. 
These files contain the components of the velocity vectors in Cartesian coordinates at each lattice point in the simulation. 
\item The first step to the post-processing of these data is to copy the files \texttt{vtk\_extract.c} 
and \texttt{vtk\_extract\_script.py} from \texttt{/trunk/util} into your working directory.
\item Edit \texttt{vtk\_extract.c}. Specifically, set the flags for:
\begin{enumerate}
\item \texttt{input\_binary\_=0} \\ if the velocity data is in ASCII format (see flag in input file),
\item \texttt{output\_binary\_=0} \\ as the output of the postprocessing routines should also be in ASCII format,
\item \texttt{output\_index=1} \\ to obtain Cartesian lattice indices \textit{i, j, k}, 
\item \texttt{vtk\_header=0} \\ to omit headers (these will be required later for visualisation in \textit{ParaView}),
\item \texttt{output\_cmf=0} to produce data in row-major format (column-major format is required for \textit{ParaView}).
\end{enumerate}
\item Edit \texttt{vtk\_extract\_script.py}. Set:
\begin{enumerate}
\item \texttt{nstart=1000}, \texttt{nint=1000} and \texttt{nend=10000} to set the range and increments of the velocity data
to be processed.
\item \texttt{vel=1} for velocity post-processing, 
\item The other flags should be set to zero, e.g. \texttt{phi=0}. 
\end{enumerate}
\item Issue the command:
\begin{lstlisting}
$ python vtk_extract_script.py
\end{lstlisting}
\item You should now see files named \texttt{vel-XXXXXXXX.vtk} (Note: The extension \texttt{.vtk} is only used here for simplicity.
It does not mean the generated data is in vtk-format). 
The first three columns of these ASCII files are the spatial lattice indices followed by the Cartesian components of the velocity vectors.\\

To plot the velocity profile of the system, you can plot the $y$-component of the velocity against 
the spatial $x$-coordinate on the lattice with the command:
\begin{lstlisting}
gnuplot> p`vel-XXXXXXXX.vtk' u 1:5
\end{lstlisting} 
By plotting the data in each file, you should be able to see the velocity profile converging to the final profile 
as shown in Fig. \ref{fig:velocityProfile}. 

In the directory \texttt{/trunk/docs/tutorial/test1} a reference file of the final 
output at time step $10,000$ can be found, in addition to a file containing the standard output of the code.
\end{enumerate} 

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.6\linewidth]{velProf.png}
  \caption{The parabolic velocity profile of a simple fluid in a cavity after $10,000$ time-steps.}
  \label{fig:velocityProfile}
  \end{center}
\end{figure}

\subsection{Test 1: Spinodal Decomposition of a Binary Fluid}

This section outlines the second example, the spinodal decomposition of a binary fluid in 
three-dimensions.
The example describes the post-processing procedure for this system and a brief guide to 
the visualisation of a 3D system using ParaView.
As in the previous example, the code should be compiled in parallel and the executable 
\texttt{Ludwig.exe} should be copied into your working directory.

\begin{enumerate}
\item Copy the input file \texttt{input} located in the directory 
\texttt{/trunk/docs/tutorial/test2} 
to your working directory. This input file contains the parameters required for this run. 
\item Run the code in your working directory by issuing the command:
\begin{lstlisting}
$ mpirun -np 8 ./Ludwig.exe input
\end{lstlisting}
\item As before, you should now see statistics being reported on your standard output but 
in this case two sets of output files being created containing the velocity and compositional
order parameter ($\phi$) data at each lattice point in the simulation. In this example, these 
data are in binary format.
\item The post-processing of these data again requires the files \texttt{vtk\_extract.c} 
and \texttt{vtk\_extract\_script.py} from \texttt{/trunk/util}.
\item Edit \texttt{vtk\_extract.c}. Specifically, set the flags for:
\begin{enumerate}
\item \texttt{input\_binary\_=1} \\ if the velocity and $\phi$ data are in binary format (see 
flag in input file),
\item \texttt{output\_binary\_=0} \\ as the output of the post-processing routines should be 
in ASCII format,
\item \texttt{output\_index=0} \\ as Cartesian lattice indices are not required, 
\item \texttt{vtk\_header=1} \\ to include headers,
\item \texttt{output\_cmf=1} to produce data in column-major format.
\end{enumerate}
\item Edit \texttt{vtk\_extract\_script.py}. Set:
\begin{enumerate}
\item \texttt{nstart=1000}, \texttt{nint=1000} and \texttt{nend=10000} to set the range and 
increments of the velocity data
to be processed.
\item \texttt{vel=1} for velocity post-processing, 
\item \texttt{phi=1} for $\phi$ post-processing,
\item The other flags should be set to zero. 
\end{enumerate}
\item Issue the command:
\begin{lstlisting}
$ python vtk_extract_script.py
\end{lstlisting}
\item You should now see files with the extension \texttt{.vtk} corresponding to the velocity 
and $\phi$ data ready to be visualised using ParaView.
\begin{enumerate}
\item Open the files containing the $\phi$ data.
\item Click on the group of files in the pipeline browser and apply a contour map using 
Filters/Common/Contour or in the tool bar: 

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.8\linewidth]{contour.png}
  \caption{The contour button in the toolbar.}
  \label{fig:contour}
  \end{center}
\end{figure}

You should now see a three-dimensional rendering of the binary fluid.
\item Open the files containing the velocity data.
\item Click on the group of files in the pipeline browser and apply the glyph filter using 
Filters/Common/Glyph or in the tool bar: 

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.8\linewidth]{glyph.png}
  \caption{The glyph button in the toolbar}
  \label{fig:glyph}
  \end{center}
\end{figure}

\item Change the colour code to GlyphVector Magnitude.
\item In the pipeline browser, you should see:

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.6\linewidth]{pipeline.png}
  \caption{The complete pipline browser for the visualisation of spinodal decomposition.}
  \label{fig:pipeline}
  \end{center}
\end{figure}

A 3D visualisation of the system should also now be shown:

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.6\linewidth]{system.png}
  \caption{A visualisation of a separating binary fluid using ParaView.}
  \label{fig:sysVisualisation}
  \end{center}
\end{figure}

\item You can move through different frames of the simulation with the arrow buttons:

\begin{figure}[H]
\begin{center}
\includegraphics[width=0.4\linewidth]{arrows.png}
  \caption{A visualisation of a separating binary fluid using ParaView.}
  \label{fig:sysVisualisation}
  \end{center}
\end{figure}

as you do this, you should see the coarsening of the binary fluid.

\item In the File menu you can save a screen shot of the visualisation or save the state of the system in order to reload the entire visualisation.
\end{enumerate}
\end{enumerate} 

%\clearpage
%\vfill\pagebreak
%\input{references.tex}

\end{document}
